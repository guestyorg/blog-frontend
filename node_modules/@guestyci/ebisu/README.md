# Ebisu

AA Guesty deploy scripts package including firebase deployment and circleci triggers.

<div align="center">
   <img src="https://farm3.staticflickr.com/2825/9548378506_d7db190155_m.jpg"/>
</div>

## Table of Contents

- [Installation](#installation)
- [Available Commands](#available-commands)
- [CircleCI Setup](#circleci-setup)
- [Injections (Custom yaml code)](#injections)
- [Manifest](#manifest-json)
- [Configurations](#configurations)
- [Optional config](#config-json)

<a name="installation"></a>

## Installation

Install the pacakge as a dev dependancy using yarn:

```sh
yarn add --dev @guestyci/ebisu
```

<a name="available-commands"></a>

## Available commands

The available ebisu commands are:

- **bootstrap** - copy latest circleci configurations to your project.
- **bootstrap-package** - copy latest circleci configurations to your project if you are writing a frontend package.
- **bootstrap-hydra** - copy latest circleci configurations to your project if you are writing a hydra.
- **bootstrap-driver** - copy latest circleci configurations to your project if you are writing a backend package.
- **push-tags** - pushes git tags to the remote repo that will trigger a circleci deployment process. You can pass `--env` to specify environemnt as follows: `--env preprod`. Please notice that in order to publish to productino you will be required to release a "Hold" job on the CircleCI workflow created by this command.
- **deploy-firebase** - deploy build or dist folder to firebase.
- **bump** - Creates a version tag and pushes it to git. Please notice that in order to publish you will be required to release a "Hold" job on the CircleCI workflow created by this command.

bump arguments:

```
ARGUMENTS
    -i (patch|minor|major)  which semver version to bump (Defaults to patch)

OPTIONS
    --stable                whether or not to push stable semver (i.e v1.5.6 instead of v1.5.5-alpha.0)
```

and they can be called using npx:

```sh
  npx ebisu bootstrap
```

<a name="circleci-setup"></a>

## Configuring project in CircleCI

1. Enter https://www.circleci.com and click “Go to app”.
2. From the main screen, click “Add projects” to the left.
3. Search for the repo name and click “Setup project” on the blue button to the end of the repo’s row.
4. From the Repo’s build folder, click “Start Building”
5. You will be passed to the project’s page. In the left column of projects, search for you project name and click the cog to the right of the name.

<a name="injections"></a>

## Injections (Custom yaml code)

Sometimes you may want to add custom code to the `config.yml` that is not in the default configurations provided. The problem is that if you change the file, the next time you will use the `bootstrap` command or it's variations, your `config.yml` will be overwritten with the default one and you will lose your custom code. In order to resolve this problem we have injections.
The concept is that you can write a custom `injection.yml` file in the `.circleci` directory that will be copied and merged to your default `config.yml` every time you bootstrap, and thus not data will be lost.
We currently support three types of injections:

1. Worflow level injections (Adding Workflows)
2. Job level injections (Adding jobs)
3. Job level changes.

Here are a few examples to clarify how to use it.

Please refer to circleci documentation or one of the platform teams if you need better understanding of the yml files in order to write what you need.

Example 1 (1 and 2 above):
Adding a job and a workflow (Such as a nightly test job)

in a file called `inject-workflow.yml` inside the `.circleci` dir.

```javascript
workflows:
  nightly:
    triggers:
      - schedule:
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - master
    jobs:
      - test_nightly

jobs:
  test:
    working_directory: ~/app
    docker:
      - image: 'circleci/node:11.15.0'
    steps:
      - attach_workspace:
          at: ~/app
      - run:
          name: Run Nightly Tests
          command: yarn test:nightly

```

This will add a new job to your workflows whenever you bootstrap.
A more complex example would be changing an existing workflow. In that case you will need to use the keys for the workflow until the place you would like to change.

Example 2 (3 above):
Changing or adding jobs to an existing workflow (Lets say a notification script). In the following example, we can see a workflow, with a build and test jobs. (ignore the \*refs).

```javascript
workflows:
  build-test-and-publish:
    jobs:
      - test:
          context: org-global-libs
          filters:
            tags: *ref_1
            branches:
              only:
                - master
      - build:
          context: org-global-libs
          requires:
            - test
          filters:
            tags: *ref_1
            branches: *ref_2
```

And we want to add a job called notify, and make build require notify in order to run. This is how to do it:

```javascript
// inject-notify.yml
workflows:
  build-test-and-deploy:
    jobs:
      - notify:
        context: org-global-libs
        filters:
          branches:
            tags: *ref_1
            branches: *ref_2
      - build:
        context: org-global-libs
        requires:
          - notify
          - test
        filters:
          tags: *ref_1
          branches: *ref_2
```

<a name="manifest-json"></a>

## manifest.json

As you all know, we have a "microfrontend" architecture, and as the number of applications grow and the need to manage them seperatly and continuously becomes more complex. For that reason, as of version 1.6.1 of ebisu, we have added support for a file called `manifest.json`. This file will be used by us to determine a few key values needed for deployment. We have tried to make it as simple and unintrusive as possible.
Below is the full list of options (fields) in the configuration, please read and understand it. After the specification, there will be an exmaple of an app so **PLEASE** take a look at it too.
Mandatory fields are marked with a \* and will fail build if missing.

```javascript
{
    // The owning github team of the project
    "owners" (*): "my-cool-team",

    // The name of the project.
    "name" (*): "mah cool project",

    // In case you want to have your app by feature toggle, use this. A truthy value for this will allow access to your app
    "featureToggle": "use-cool-app",

    // The domain of your project. Defaults to none, and assumes app.guesty.com
    "domain": "my.cooldomain.com",

    // Optional Object specifing dashboard presentation
    "microApp": {

      // Your iframe src source. This is mandatory if you have the layoutPage object in the config.
      "iframeSrc*" (*): "/apps/cool-app",

      // Your application url to be seen in the main address bar. Mandatory if you have the layoutPage in the config
      "path" (*): "/cool-app",

      // Determines wether or not the app will be in the navigation header as a clickable route.
      // In case 'true', will be added in the last position under the "parent" tab.
      // In case no parent is specified, will be in the top level navigation header.
      // The tab title will be taken from the title option. If no title is present, the app 'name' will be used as one. Defaults to false.
      "showAsItem": false,

      // In case 'showAsItem' is true, use this title as the button title (label).
      "title": "Marketplace",

      // In case 'showAsItem' is true, the parent tab if you want to be a nested tab and not in the top level of the header.
      "parent": "Integrations",

      // In case you do not want to be an item, which means 'showAsItem' is false and parent is null,
      // "highlight" marks the title of the tab to be active when reaching your application
      "highlight": "Integrations",

      // This will be the document title for the app route. In case it is not specified will be default 'Guesty'.
      "documentTitle": "My Cool App!",
    },

    // Optional array of roles if you want the tab to be shown only to specific roles
    "roles": [
      "listing.manager",
      "listing.admin",
      "manager",
      "admin"
    ],

    // Optional value (NOT NEEDED most cases) for nginx configurations most apps don't need it.
    // Should only be used as a bailout after consulting to ui-infra. The values are as key values of nginx.
    // You can use {{}} in order to mark env variables to be replace. i.e https://s3.guesty.com/branches/{{env}}/my-project
    "nginx": {
      "location": "= /register",
      "return": "301 /registration",
      "proxy_redirect": "off"
    },

    // Optional value (NOT NEEDED most cases) for Firebase legacy support. Most apps don't need it.
    // Receives values for app name per environemnt. Should only be used as a bailout after consulting to ui-infra.
    "firebase": {
       "production": "my-app-on-firebase",
       "staging": "my-app-staging51-notverygood"
    },

    // Optional value (NOT NEEDED most cases) if you have a very unique routes definition and should only be used as a bailout after consulting to ui-infra.
    // This will copy to routes directly to the routes creation in the layout. Specification is in layout project "routes.js".
    "routes": {
      "label": "System",
      "path": "/account/system/:tab",
      "src": "/legacy/account/system",
      "excludedFromNavBar": true
    }
}
```

That means that this is a very valid, healty and good configuration:

```javascript
{
    "owners": "biz",
    "name": "reservation page",
    "microApp": {
      "path": "/reservations/:id",
      "iframeSrc": "/apps/reservation-page"
    }
}
```

<a name="config-json"></a>

## config.json

It's possible to customize your circle deployment/build scripts in your `.circleci/config.json`  
Here is an example of some of the options:

```javascript
{
  "e2e": {
    "cluster": ""
  },
  "destinations": {
    "staging": "my-app-staging-1-new-id"
  },
  "build_scripts": {
    // custom build script per env to run instead of built in option
    "production": "build:production"
  },
   "deploy_scripts": {
    // custom deploy scripts to be run instead of the built in option.
    "production": "",
     "staging": ""
   },
   "s3_config": {
      // Customize deployment to s3 parameters: see https://www.npmjs.com/package/s3-website for options
   }
}
```

this will use the build script "build:production" instead of build when in production, and deploy to "my-app-staging-1-new-id" instead of "my-app-staging" while in staging.

<a name="configurations"></a>

## Optional Configurations

It is possible to configure a default cluster for all the deployments of the pacakge, using package.json. In order to set it up, define an ebisu object in the package.json of the app, with a cluster variable. For example:

```javascript
{
    "name": "dashboard-app-inbox",
    "version": "4.0.6",
    "description": "",
    "main": "index.js",
    "ebisu": {
        "cluster": "staging5"
}
```

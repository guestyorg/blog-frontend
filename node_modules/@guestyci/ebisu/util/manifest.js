const git = require('./git');
const files = require('./files');
const fs = require('fs');
const path = require('path');

const hasChanged = () => {
  if (!isExists()) {
    return false;
  }

  return !!git.getDiffFromRemoteLastCommit('manifest.json');
};

const isValid = () => {
  const manifest = files.getManifest();
  const manifestString = JSON.stringify(manifest);

  if (manifestString.includes('<<')) {
    return false;
  }

  return true;
};

const isExists = () => {
  const manifestPath = path.resolve(process.cwd(), 'manifest.json');
  if (fs.existsSync(manifestPath)) {
    return true;
  }

  return false;
};

const isInInventory = async (api, app) =>
  await api.checkIfFileExists({
    repo: 'platform-inventory',
    branch: 'master',
    file: `dimensions/y/apps/${app}.json`,
  });

module.exports = {
  hasChanged,
  isValid,
  isInInventory,
};

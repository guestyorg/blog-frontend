#!/usr/bin/env node

const util = require('util');
const fs = require('fs');

const exec = util.promisify(require('child_process').exec);

const git = require('../util/git');

const { getAppName } = require('../util/files');
const { fillPublicURL } = require('../scripts/deploy-s3');

const start = async ({
  CLUSTER: cluster = 'development',
  GIT_COMMIT: commit,
  REPO_NAME: repoName,
  FIREBASE_APP,
} = {}) => {
  const commands = [];
  const appName = getAppName();

  fillPublicURL({
    cluster,
    commit,
    repoName,
    firebaseApp: FIREBASE_APP,
  });

  console.log(`deploying to ${FIREBASE_APP} with cluster ${cluster}`);

  if (cluster !== 'development' && cluster !== 'feature') {
    commands.push('yarn firebase use "$FIREBASE_APP"');
    commands.push(
      'yarn firebase deploy --debug -m "$GIT_COMMIT" --token "$FIREBASE_TOKEN"'
    );
  } else {
    commands.push(`rm -rf ./feature/${appName}`);
    commands.push(`mkdir -p ./feature/${appName}`);
    commands.push(`cp -r ./build/ ./feature/${appName}`);
  }

  const { stdout, stderr, error } = await exec(commands.join(' && '));
  console.log('deploy to firebase finished successfully');
};

module.exports = start;

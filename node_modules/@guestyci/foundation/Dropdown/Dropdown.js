"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports["default"] = exports.useStyles = void 0;

var _defineProperty2 = _interopRequireDefault(require("@babel/runtime/helpers/defineProperty"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _react = _interopRequireWildcard(require("react"));

var _classnames = _interopRequireDefault(require("classnames"));

var _propTypes = _interopRequireDefault(require("prop-types"));

var _isEmpty = _interopRequireDefault(require("lodash/isEmpty"));

var _createStyles = _interopRequireDefault(require("../createStyles"));

var _DropdownInput = _interopRequireDefault(require("./DropdownInput"));

var _Menu = _interopRequireDefault(require("../Menu/Menu"));

var _composeEvent = _interopRequireDefault(require("../utils/composeEvent"));

var _TextField = _interopRequireDefault(require("../TextField"));

var _DropdownSearch = _interopRequireDefault(require("./DropdownSearch"));

var _DropdownMenuList = _interopRequireDefault(require("./DropdownMenuList"));

var _InfiniteScroll = _interopRequireDefault(require("../InfiniteScroll"));

var useStyles = (0, _createStyles["default"])(function (theme) {
  return {
    root: {
      display: 'flex',
      width: '100%',
      position: 'relative',
      flexFlow: 'column'
    },
    input: {
      marginLeft: theme.spacer(1),
      width: "calc(100% - ".concat(theme.spacer(2), "px)")
    },
    menu: {
      overflowY: 'hidden',
      maxHeight: '100%'
    },
    menuList: {
      maxHeight: 260,
      padding: 0
    },
    scrollable: {
      overflowY: 'auto'
    },
    searchableMaxHeight: {
      maxHeight: 220
    },
    initialLoading: {
      height: 180
    },
    emptyState: {
      color: theme.palette.text.secondary,
      paddingLeft: theme.spacer(1),
      paddingTop: theme.spacer(1)
    }
  };
}, {
  name: 'Dropdown'
});
exports.useStyles = useStyles;
var loaderOverride = {
  loader: {
    height: '100%'
  }
};

var Dropdown = _react["default"].forwardRef(function Dropdown(_ref, ref) {
  var _cn;

  var children = _ref.children,
      input = _ref.input,
      placeholder = _ref.placeholder,
      inputProps = _ref.inputProps,
      renderComponent = _ref.renderComponent,
      className = _ref.className,
      style = _ref.style,
      jss = _ref.jss,
      onChange = _ref.onChange,
      renderSelected = _ref.renderSelected,
      value = _ref.value,
      variant = _ref.variant,
      searchable = _ref.searchable,
      onSearchQueryChange = _ref.onSearchQueryChange,
      disabled = _ref.disabled,
      emptyStateComponent = _ref.emptyStateComponent,
      name = _ref.name,
      error = _ref.error,
      menuWidth = _ref.menuWidth,
      infiniteScrollOptions = _ref.infiniteScrollOptions,
      props = (0, _objectWithoutProperties2["default"])(_ref, ["children", "input", "placeholder", "inputProps", "renderComponent", "className", "style", "jss", "onChange", "renderSelected", "value", "variant", "searchable", "onSearchQueryChange", "disabled", "emptyStateComponent", "name", "error", "menuWidth", "infiniteScrollOptions"]);
  var classes = useStyles({
    jss: jss
  });
  var dropdownAnchorRef = (0, _react.useRef)();
  var searchInputRef = (0, _react.useRef)();

  var _useState = (0, _react.useState)(false),
      _useState2 = (0, _slicedToArray2["default"])(_useState, 2),
      open = _useState2[0],
      setOpen = _useState2[1];

  var _useState3 = (0, _react.useState)(''),
      _useState4 = (0, _slicedToArray2["default"])(_useState3, 2),
      query = _useState4[0],
      setQuery = _useState4[1];

  (0, _react.useEffect)(function () {
    if (open && searchable && searchInputRef) {
      setTimeout(function () {
        return searchInputRef.current.focus();
      }, 0);
    }
  }, [open]);

  var handleInputClick = function handleInputClick() {
    setOpen(!open);
  };

  var handleDismissDropdown = function handleDismissDropdown() {
    setOpen(false);
  };

  var dispatchOnChange = function dispatchOnChange(e, selectedValue) {
    e.stopPropagation();
    var newEvent = (0, _composeEvent["default"])(e, {
      name: name,
      value: selectedValue
    });
    onChange(newEvent, selectedValue);

    if (variant === 'single') {
      handleDismissDropdown();
    }
  };

  var handleSelectItem = (0, _react.useCallback)(function (e, menuItemValue) {
    setQuery('');
    dispatchOnChange(e, menuItemValue);
  }, [setQuery, dispatchOnChange]);

  var handleSearchInputChange = function handleSearchInputChange(e) {
    var searchQueryValue = e.currentTarget.value;
    setQuery(searchQueryValue);
    onSearchQueryChange((0, _composeEvent["default"])(e, {
      name: name
    }));
  };

  var handleClearSearchInputQuery = function handleClearSearchInputQuery(e) {
    setQuery('');
    onSearchQueryChange((0, _composeEvent["default"])(e, {
      name: name,
      value: ''
    }));
  };

  var handleClearValue = function handleClearValue(e) {
    // Due to bug in redux form, we must pass null
    // see details here: https://github.com/redux-form/redux-form/issues/3946
    dispatchOnChange(e, null);
  };

  var isLoading = infiniteScrollOptions.isLoading;

  var InputComponent = input || /*#__PURE__*/_react["default"].createElement(_DropdownInput["default"], null);

  var shouldShowEmptyState = (0, _isEmpty["default"])(children) && !isLoading;
  var isInfiniteScroll = infiniteScrollOptions.totalCount;
  var emptyStateMessage = searchable && query ? 'No results found.' : emptyStateComponent;
  return /*#__PURE__*/_react["default"].createElement("div", (0, _extends2["default"])({
    className: (0, _classnames["default"])(classes.root, className),
    style: style,
    ref: ref
  }, props), _react["default"].cloneElement(InputComponent, (0, _extends2["default"])({
    ref: dropdownAnchorRef,
    open: open,
    name: name,
    variant: variant,
    disabled: disabled,
    value: value,
    placeholder: placeholder,
    renderComponent: renderComponent,
    renderSelected: renderSelected,
    onClear: handleClearValue,
    onClick: handleInputClick,
    onChange: dispatchOnChange,
    error: error
  }, inputProps)), /*#__PURE__*/_react["default"].createElement(_Menu["default"], {
    variant: "menu",
    menuWidth: menuWidth,
    open: open,
    onClose: handleDismissDropdown,
    className: classes.menu,
    anchorDirection: "start",
    originDirection: "bottom",
    fitAnchor: true,
    anchor: dropdownAnchorRef
  }, searchable && /*#__PURE__*/_react["default"].createElement(_DropdownSearch["default"], {
    ref: searchInputRef,
    value: query,
    onChange: handleSearchInputChange,
    onClear: handleClearSearchInputQuery,
    className: classes.input
  }), /*#__PURE__*/_react["default"].createElement(_Menu["default"], {
    variant: "list",
    elevation: 0,
    className: (0, _classnames["default"])(classes.menuList, (_cn = {}, (0, _defineProperty2["default"])(_cn, classes.initialLoading, isLoading && (0, _isEmpty["default"])(children)), (0, _defineProperty2["default"])(_cn, classes.scrollable, !isInfiniteScroll), (0, _defineProperty2["default"])(_cn, classes.searchableMaxHeight, searchable), _cn))
  }, /*#__PURE__*/_react["default"].createElement(_InfiniteScroll["default"], (0, _extends2["default"])({}, infiniteScrollOptions, {
    jss: loaderOverride
  }), /*#__PURE__*/_react["default"].createElement(_DropdownMenuList["default"], {
    variant: variant,
    value: value,
    disabled: disabled,
    onChange: handleSelectItem
  }, children))), shouldShowEmptyState && emptyStateMessage && /*#__PURE__*/_react["default"].createElement(_TextField["default"], {
    className: (0, _classnames["default"])(classes.emptyState)
  }, emptyStateMessage)));
});

Dropdown.defaultProps = {
  searchable: false,
  placeholder: 'Select an option',
  onSearchQueryChange: null,
  className: '',
  style: {},
  name: '',
  value: undefined,
  disabled: false,
  variant: 'single',
  emptyStateComponent: null,
  renderComponent: null,
  infiniteScrollOptions: {}
};
Dropdown.propTypes = {
  /** Dropdown menuItem options to provide to the dropdown
   * Use <MenuItem> component for rendering children
   */
  children: _propTypes["default"].arrayOf(_propTypes["default"].node).isRequired,

  /** Indicator whether or not the input field is searchable */
  searchable: _propTypes["default"].bool,

  /** Placeholder for input field */
  placeholder: _propTypes["default"].string,

  /** Empty state component  to display when there're no results */
  emptyStateComponent: _propTypes["default"].node,

  /** Mandatory if searchable - callback for on input change */
  onSearchQueryChange: _propTypes["default"].func,

  /** Callback function to be called on value changed - arguments - (event, value)
   * event will contain the html dom value converted to string, to access the full value, use the second argument
   * */
  onChange: _propTypes["default"].func.isRequired,

  /** Additional class for dropdown root */
  className: _propTypes["default"].string,

  /** Additional style for dropdown root */
  style: _propTypes["default"].shape(),

  /** form element name */
  name: _propTypes["default"].string,

  /** Selected dropdown value */
  value: _propTypes["default"].oneOfType([_propTypes["default"].shape(), _propTypes["default"].array, _propTypes["default"].string, _propTypes["default"].number]),

  /** Set the dropdown content menu width manually - by default it will resolve to the larger of the input width or the content width */
  menuWidth: _propTypes["default"].number,

  /** Indicator for disabled status */
  disabled: _propTypes["default"].bool,

  /** variant for the type of dropdown we want to render - values [single, multiselect, chip] */
  variant: _propTypes["default"].oneOf(['single', 'multiselect', 'chip']),

  /** custom props to pass to the input component */
  inputProps: _propTypes["default"].shape(),

  /** DEPRECATED- USE renderSelected */
  renderComponent: _propTypes["default"].func,

  /** Set the input component to show on selected item, Accepting function and String
   * If strings - will render the value[renderSelected].
   * If function - will pass the value props
   * */
  renderSelected: _propTypes["default"].oneOfType([_propTypes["default"].func, _propTypes["default"].string]),

  /** Object to define infinite scrolling behaviour */
  infiniteScrollOptions: _propTypes["default"].shape({
    /** starting index of the chunk */
    skip: _propTypes["default"].number,

    /** cb to notify about required loads */
    onLoadMore: _propTypes["default"].func,

    /** total number of entries */
    totalCount: _propTypes["default"].number,

    /** offset from the bottom, from which loading the next chunk should be triggered */
    scrollOffset: _propTypes["default"].number,

    /** number of rows per page */
    pageSize: _propTypes["default"].number
  }),

  /** indicator for data fetching state */
  isLoading: _propTypes["default"].bool
};
Dropdown.displayName = 'Dropdown';
var _default = Dropdown;
exports["default"] = _default;
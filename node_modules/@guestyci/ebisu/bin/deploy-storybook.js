#!/usr/bin/env node

const chalk = require('chalk');
const ora = require('ora');

const spinner = ora();
const src = './livebook';
const storybookConfigDir = './.storybook';

const git = require('../util/git');

const {
  buildStorybook,
  deployLivebook,
  shouldUploadToStorybook,
} = require('../scripts/deploy-storybook');

async function run({ TAG, BRANCH, S3_LIVEBOOK_BUCKET }) {
  try {
    if (shouldUploadToStorybook(TAG, storybookConfigDir)) {
      spinner.start(`Building storybook to ${chalk.green(src)}`);
      await buildStorybook(src);
      spinner.succeed('Build success!');

      spinner.start('Starting deploy process to livebook');
      const address = deployLivebook(BRANCH, S3_LIVEBOOK_BUCKET, src);
      spinner.succeed('Storybook has been successfully uploaded!');

      console.log('You can access it at: ' + chalk.green(address));
    } else {
      console.log(chalk.red('Skipping Deploy'));
      console.log('Skip might occur in the following cases:');
      console.log(`No ${chalk.cyan('.storybook')} folder exists`);
      console.log('Deploying to alpha tag'); //???
    }
  } catch (e) {
    spinner.stop();
    throw e;
  }
}

module.exports = run;

const git = require('../util/git');
const files = require('../util/files');
const manifest = require('../util/manifest');

const pushTags = async env => {
  const [commit, branch] = await git.getCommitAndBranch();

  await git.validateCommitOnRemote({ commit, branch });
  await git.validateMergedWithMaster(branch);

  const tag = `${branch}--${commit}-rc.${env}`;

  const isManifestChanged = manifest.hasChanged();

  if (isManifestChanged) {
    const isManifestValid = manifest.isValid();
    if (!isManifestValid) {
      throw new Error(
        'Cannot build manifest file and so built is canceled. Please check manifest.json for illigal values (refer to documentation)'
      );
    }
  }

  return git.makeAndPushTag(tag);
};

module.exports = {
  pushTags,
};

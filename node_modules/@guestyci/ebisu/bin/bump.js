#!/usr/bin/env node

const ora = require('ora');
const chalk = require('chalk');

const git = require('../util/git');

const { loadPackageJson } = require('../util/files');

const { updateVersion, updateChangelog } = require('../scripts/bump');

const spinner = ora({ spinner: 'triangle' });
spinner.color = 'green';

const bump = async ({ i: inc, stable }) => {
  spinner.start(' Doing git stuff, please wait..');

  const branch = git.getBranch();

  if (stable && branch !== 'master') {
    spinner.stop();
    throw new Error(
      'Stable version can only be deployed from master, not ' + branch
    );
  }

  try {
    await git.validateGitIsClean();

    const packageJson = loadPackageJson();
    const newVersion = updateVersion(packageJson, inc, stable);

    const newTag = `v${newVersion}`;

    await updateChangelog(newVersion);
    await git.addAllAndCommitWithMessage(newTag);
    await git.tag(newTag);
    await git.pushTagAndBranch({ tag: newTag, branch });

    spinner.succeed(
      `Started deploy process for ${chalk.bold.blue(
        packageJson.name
      )} version ${chalk.bold.blue(newVersion)}`
    );
  } catch (e) {
    spinner.stop();
    throw e;
  }
};

module.exports = bump;

#!/usr/bin/env node

const git = require('../util/git');

function pushSbBranch(branch) {
  git.validateGitIsClean();

  const sbBranch = branch.startsWith('sb.') ? branch : `sb.${branch}`;

  git.checkoutOrCreate(sbBranch);
  git.resetHard(`origin/${branch}`);
  git.pushForceUnsafe(sbBranch);
  git.checkout(branch);

  console.log(`Started Storybook deployment process  for ${branch} `);
  console.log('The deployment process can be seen in CircleCi');
}

async function run() {
  const branch = git.getBranch();
  const commit = git.getCommit();
  await git.validateCommitOnRemote({ commit, branch });
  pushSbBranch(branch);
}

module.exports = run;

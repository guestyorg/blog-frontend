const { getDiffFromRemote, getCommitAndBranch } = require('../util/git');

const getDiffFromRemoteWithFallback = () => {
  try {
    return getDiffFromRemote();
  } catch (err) {
    return false;
  }
};

const createTagFromRegex = async (
  RegexRoles,
  filesDiff = getDiffFromRemoteWithFallback()
) => {
  const [commit, branch] = await getCommitAndBranch();

  const resultTag = filesDiff
    ? Object.entries(RegexRoles)
        .filter(([key, regex]) => RegExp(regex).test(filesDiff))
        .map(([key, regex]) => key)
        .join('.')
    : 'build';

  return `${branch}.${resultTag}.${commit}`;
};

module.exports = {
  createTagFromRegex,
};

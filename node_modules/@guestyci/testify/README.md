# Platform-libs-testify

**UI component testing utility for Guesty**

## Installation

npm:

```bash
    npm install @guestyci/testify
```

yarn:

```bash
    yarn add @guestyci/testify
```

## Usage

### Base tests

All components should be tests, for snapshot and logic.

testify has a `componentBaseTest` to run all the generic tests.

```javascript
import { componentBaseTest } from '@guestyci/testify/react';
import ComponentName from './<path_to_component>';

const propTypes = {
  // all of the component prop types defined here
};
describe('<Flow> test suit', () => {
  componentBaseTest(ComponentName, propTypes);
  // rest of tests here
});
```

### Setups

in order to test logic, you will need to setup your component. you can use the beforeEach hook, But we prefer the setup methodology.

**Note: all of the dependencies are included, there is no need to add axios or nock etc to your project**

#### setup

```javascript
import { componentBaseTest, setup } from '@guestyci/testify/react';
import { mockFn } from '@guestyci/testify/utils';
import ComponentName from './<path_to_component>';

const propTypes = {
  // all of the component prop types defined here
  onClick: mockFn(),
};

const componentSetup = setup(ComponentName);
describe('<Flow> test suit', () => {
  componentBaseTest(ComponentName, propTypes);
  test('Should mark mockFn as read on click', () => {
    const wrapper = componentSetup(propTypes);
    wrapper.simulate('click');
    expect(mockFn).toHaveBeenCalled();
  });
});
```

setup accepts a few arguments:
( component, isMount, appentTo) => ...

| Arg       |                                           Desc                                            |                                           type |
| --------- | :---------------------------------------------------------------------------------------: | ---------------------------------------------: |
| component |                                the react component to test                                |                                react component |
| isMount   |               boolean indicator whether we want to mount or shallow render                |                                        boolean |
| appendTo  | In rare cases (tooltips/popovers) you want to attach a mounted component to an uppder DOM | DOM node (usually used with createContainer()) |

#### jssSetup

Use when testing components using jss (createStyles) classes

```javascript
import {
  componentBaseTest,
  jssSetup,
  getClasses,
} from '@guestyci/testify/react';
import ComponentName, { useStyles } from './<path_to_component>';

const propTypes = {
  // all of the component prop types defined here
};
const classes = getClasses(ComponentName, useStyles);
const componentSetup = jssSetup(ComponentName);
describe('<Flow> test suit', () => {
  componentBaseTest(ComponentName, propTypes);
  test('Should mark mockFn as read on click', () => {
    const wrapper = componentSetup(propTypes);
    expect(wrapper.hasClass(classes.foot)).toBe(true);
  });
});
```

setup accepts a few arguments:
( component, isMount, appentTo) => ...

| Arg       |                                    Desc                                     |            type |
| --------- | :-------------------------------------------------------------------------: | --------------: |
| component |                         the react component to test                         | react component |
| options   | Options to pass to the setup, {isMount, appendTo, all other enzyme options} |          Object |

#### actionSetup

setup for testing redux flows

Lets assume we want to test the following action:

```javascript
   import { makeAsyncActionCreator } from '@guestyci/redux-tools';
    const fetchItemsActions = makeAsyncActionCreator(FEATURE_TYPE, 'items', 'error');

    deserializeServerData = (items) => items.map( item => ({...item, fullName: `${item.firstName} ${item.lastName}`}))

    export const setItem = makeActionCreator(FEATURE_ACTION_TYPE, 'id', 'item');

    export function fetchItems(id) {
       return async (dispatch, getState, api) => {
         dispatch(fetchItemsActions.request());
         try {
           const resp = await api.get(url);
           const { data: { results, count } } = resp;
           dispatch(fetchItemsActions.success(deserializeServerData(results));
         } catch (err) {
           dispatch(fetchItemsActions.failure(err));
         }
       };

```

Testing redux async actions might be a bit more difficult, to do that we have provided the actionSetup method.

```javascript
import { actionSetup } from '@guestyci/testify/redux';

const successResponse = { count: 60,
  results: [
    { _id: 1, accountId: 1, meta: {} },
    { _id: 2, accountId: 1, meta: {} },
    { _id: 3, accountId: 1, meta: {} },
  ] };

const actionsSetup = actionSetup();
    describe('fetchItems Unit Tests', () => {
      test('Should successfully fetch items', async () => {
        const { store, nock } = actionsSetup({ <reducerStoreName>: initialState });
        nock.get(<api_url>).query(true).reply(200, successResponse);
        const actions = [
          { type: `${FEATURE_TYPE} ${API_REQUEST}`},
          { type: `${FEATURE_TYPE} ${API_SUCCESS}`, items: deserializeServerData(successResponse.results) },
        ];
        await store.dispatch(fetchItems());
        expect(store.getActions()).toEqual(actions);
      });

      test('Should fail to fetch the feed items', async () => {
        const { store, nock } = feedActionsSetup({ <reducerStoreName>: initialState });
        nock.get(<api_url>).query(true).replyWithError(errorResponse);
        const actions = [
          { type: `${FEATURE_TYPE} ${API_REQUEST}`},
          { type: `${FEATURE_TYPE} ${API_FAILURE}`, error: errorResponse },
        ];
        await store.dispatch(fetchItems());
        expect(store.getActions()).toEqual(actions);
      });
    });
```

For custom middleware (default is thunk) or for custom api you can set it in the action:

```javascript
import thunk from 'redux-thunk';
    import nock from 'nock';
    import httpAdapter from 'axios/lib/adapters/http';
    import Resource from '@guestyci/agni';
    import { actionSetup } from '@guestyci/testify/redux';


    const { api } = Resource.create();
    http.defaults.adapter = httpAdapter;
    const actionsSetup = actionSetup([thunk.withExtraArgument(api)], <ServiceBaseUrl>);
```

setupAction accepts few arguments:

| Arg              |                           Desc                           |   type |                        default |
| ---------------- | :------------------------------------------------------: | -----: | -----------------------------: |
| middleware       |            array of middlewares for the store            |  Array | [thunk.withExtraArgument(api)] |
| Service base url | Base url to mock, either the Config key or absolute path | String |                      'API_URL' |

and will return a function which accepts the following arguments:

| Arg   |             Desc              |   type |
| ----- | :---------------------------: | -----: |
| store | the inital state of the store | Object |

#### containerSetup

**setup for testing container components(connected to redux store).**

**Notice:** containerSetup will always `mount` the component

```javascript
import MyComponent from './MyComponent';
import { mockFn } from '@guestyci/testify/utils';
import { setupContainer } from '@guestyci/testify/redux';

const initalStore = {
  todos: [],
  isFetching: true,
};

const props = {
  onSubmit: mockFn(),
};

const { WrappedComponent, componentSetup } = setupContainer(
  MyComponent,
  initalStore
);

describe('MyComponent Unit Tests', () => {
  componentBaseTest(WrappedComponent, props, <WrappedComponent {...props} />);

  it('should call onSubmit function one time on submit', () => {
    const wrapper = componentSetup(
      { additionalProp: 'as', isFetching: flase },
      props
    );

    expect(props.onSubmit.mock.calls.length).toEqual(0);
    wrapper.find('form').simulate('submit');
    expect(props.onSubmit.mock.calls.length).toEqual(1);
  });
});
```

containerSetup accepts few arguments:

| Arg         |                  Desc                   |            type |
| ----------- | :-------------------------------------: | --------------: |
| Comp        | the react container's component to test | React Component |
| initalStore |    the inital store of the component    |          Object |

and will return a function which accepts the following arguments:

| Arg             |                                           Desc                                            |                                           type |
| --------------- | :---------------------------------------------------------------------------------------: | ---------------------------------------------: |
| additionalStore |            additional props for the store(possible to override existing props)            |                                         Object |
| isMount         |               boolean indicator whether we want to mount or shallow render                |                                        boolean |
| appendTo        | In rare cases (tooltips/popovers) you want to attach a mounted component to an uppder DOM | DOM node (usually used with createContainer()) |

<br><br>

To see the list of other utilities check out [source code](https://github.com/guestyorg/platform-fe-libs-testify/blob/master/src/setup.js)

## Utils

The are a few generic utilites added in the library:

All utils are accessible via the root

```javascript
import { mockFn, ...} from '@guestyci/testify/utils'
```

Available utilities:

| function        |                  description                  |              arguments |         return |
| --------------- | :-------------------------------------------: | ---------------------: | -------------: |
| createContainer |  generates container div and appends to body  |                     id |     a dom node |
| mockFn          |       creates a jst.fn instance to use        |                   none |  mock function |
| clearMocks      | mocks are not cleared this method clears them |                   none |      undefined |
| mount           |             enzyme mount function             |              component | a mount object |
| shallow         |            enzyme shallow function            | a shallow mount object |      undefined |

for the rest of the utils, please see [source code](https://github.com/guestyorg/platform-fe-libs-testify/blob/master/src/utility.js).

## How to test functional Component with hooks

In case you want to test functional components with hooks without using containerSetup(which mount the whole component) we provide some mock functions to test react-redux hooks.

Available mocks:

| function        |        description        |                 arguments |                                                         return |
| --------------- | :-----------------------: | ------------------------: | -------------------------------------------------------------: |
| useSelectorStub |   stub for useSelector    |                      none |                                                      undefined |
| useDispatchMock | mock for useDispatch hook |                      none |                                     mock function for dispatch |
| mockHook        |   mock for react hooks    |      hook(string), cb(fn) |  mock the react hook and pass an optional callback when called |
| mockCustomHook  |     mock custom hook      | hook(import path), cb(fn) | mock the custom hook and pass an optional callback when called |

**Notice: When using useSelectorStub, you should create mock for each selector that called by useSelector**

#### Example:

```javascript
import { useSelectorMock, useDispatchMock } from '@guestyci/testify/redux';
import * as todosSelectors from './todos.selectors';

const initalState = {
  todos: [],
};

// Create mock for the selector
todosSelectors.getTodos = jest.fn(() => initalState.todos);
useSelectorStub();
const dispatch = useDispatchMock();
```

## Testing custom hook

We had included in `v1.3.0` the `renderHook` utility for testing custom hooks

### Example:

Lets assume we have the following hook:

```javascript
//useSomething.js
import { useState, useCallback } from 'react';

const useSomething = (initialValue = true) => {
  const [isSomething, setSomething] = useState(initialValue);
  const toggleSomething = useCallback(() => setSomething(!isSomething), [
    isSomething,
  ]);
  return [isSomething, toggleSomething];
};

export default useSomething;
```

```javascript
//useSomething.test.js
import { renderHook } from '@guestyci/testify';
import useSomething from './useSomething';

describe('useSomething test suit', () => {
  test('Should show isCollapsed as true by default', () => {
    const useSomethingHook = renderHook(useSomething);
    const [isCollapsed] = useSomethingHook();
    expect(isCollapsed).toEqual(true);
  });
  test('Should show isCollapsed default value as passed', () => {
    const useSomethingHook = renderHook(useSomething, false);
    const [isCollapsed] = useSomethingHook();
    expect(isCollapsed).toEqual(false);
  });
  test('Should toggle is collapsed if clicked on toggle', () => {
    const useSomethingHook = renderHook(useSomething);
    let [isCollapsed, toggleCollapse] = useSomethingHook();
    expect(isCollapsed).toEqual(true);
    toggleCollapse();
    [isCollapsed, toggleCollapse] = useSomethingHook();
    expect(isCollapsed).toEqual(false);
  });
});
```

## Changelog

For updates please refer to our [changelog](https://github.com/guestyorg/platform-fe-libs-testify/blob/master/CHANGELOG.md)
